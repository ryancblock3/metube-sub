<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube to MeTube</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23667eea'><path d='M10,15L15.19,12L10,9V15M21.56,7.17C21.69,7.64 21.78,8.27 21.84,9.07C21.91,9.87 21.94,10.56 21.94,11.16L22,12C22,12 22,13.94 21.56,16.83C21.31,18.05 20.46,18.89 19.25,19.14C16.38,19.59 12,19.59 12,19.59C12,19.59 7.62,19.59 4.75,19.14C3.54,18.89 2.69,18.05 2.44,16.83C2,13.94 2,12 2,12C2,12 2,10.06 2.44,7.17C2.69,5.95 3.54,5.11 4.75,4.86C7.62,4.41 12,4.41 12,4.41C12,4.41 16.38,4.41 19.25,4.86C20.46,5.11 21.31,5.95 21.56,7.17Z'/></svg>">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }
        
        .content {
            padding: 30px;
        }
        
        .form-section {
            background: #f8f9ff;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid #e1e8ff;
        }
        
        .form-section h3 {
            color: #2d3748;
            margin-bottom: 20px;
            font-size: 1.3em;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #4a5568;
            font-weight: 500;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }
        
        .checkbox-group input[type="checkbox"] {
            width: auto;
            transform: scale(1.2);
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        
        .btn:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
        }
        
        .videos-section {
            background: #f7fafc;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid #e2e8f0;
        }
        
        .videos-list {
            max-height: 300px;
            overflow-y: auto;
            background: white;
            border-radius: 10px;
            border: 1px solid #e2e8f0;
        }
        
        .video-item {
            padding: 15px;
            border-bottom: 1px solid #f1f5f9;
            display: grid;
            grid-template-columns: auto auto 1fr auto auto auto;
            gap: 15px;
            align-items: center;
            transition: background 0.2s ease;
        }
        
        .downloaded-video-item {
            padding: 15px;
            border-bottom: 1px solid #f1f5f9;
            display: grid;
            grid-template-columns: auto 1fr auto auto auto;
            gap: 15px;
            align-items: center;
            transition: background 0.2s ease;
        }
        
        .channel-section {
            background: white;
            border-radius: 15px;
            margin-bottom: 20px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border: 1px solid #e2e8f0;
        }
        
        .channel-header {
            background: linear-gradient(135deg, #4a5568 0%, #2d3748 100%);
            color: white;
            padding: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: all 0.3s ease;
        }
        
        .channel-header:hover {
            background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
        }
        
        .channel-header.collapsed {
            border-bottom: none;
        }
        
        .channel-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .channel-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #667eea;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 16px;
        }
        
        .channel-details h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
        }
        
        .channel-stats {
            font-size: 14px;
            opacity: 0.9;
            margin-top: 2px;
        }
        
        .channel-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .channel-toggle {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
            transition: background 0.2s ease;
        }
        
        .channel-toggle:hover {
            background: rgba(255,255,255,0.1);
        }
        
        .channel-videos {
            background: #f8fafc;
            max-height: 500px;
            overflow-y: auto;
            transition: all 0.3s ease;
        }
        
        .channel-videos.collapsed {
            max-height: 0;
            overflow: hidden;
        }
        
        .channel-video-item {
            padding: 15px 20px;
            border-bottom: 1px solid #e2e8f0;
            display: grid;
            grid-template-columns: auto 1fr auto auto auto;
            gap: 15px;
            align-items: center;
            background: white;
            transition: background 0.2s ease;
        }
        
        .channel-video-item:hover {
            background: #f1f5f9;
        }
        
        .channel-video-item:last-child {
            border-bottom: none;
        }
        
        .channel-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .btn-channel {
            padding: 6px 12px;
            font-size: 12px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        
        .btn-channel-danger {
            background: #fed7d7;
            color: #c53030;
        }
        
        .btn-channel-danger:hover {
            background: #feb2b2;
        }
        
        .channel-summary {
            background: #edf2f7;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top: 1px solid #e2e8f0;
        }
        
        .summary-item {
            text-align: center;
        }
        
        .summary-number {
            font-size: 20px;
            font-weight: bold;
            color: #2d3748;
        }
        
        .summary-label {
            font-size: 12px;
            color: #718096;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .video-item:hover, .downloaded-video-item:hover {
            background: #f8fafc;
        }
        
        .video-filesize {
            background: #e2e8f0;
            color: #4a5568;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
            min-width: auto;
        }
        
        .video-item:last-child {
            border-bottom: none;
        }
        
        .video-item input[type="checkbox"] {
            transform: scale(1.2);
        }
        
        .video-info {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .video-title {
            color: #2d3748;
            font-weight: 500;
            font-size: 14px;
        }
        
        .video-url {
            color: #718096;
            text-decoration: none;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 12px;
        }
        
        .video-url:hover {
            color: #667eea;
        }
        
        .video-duration {
            background: #edf2f7;
            color: #4a5568;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .quality-select {
            padding: 6px 10px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 12px;
            min-width: 80px;
        }
        
        .video-thumbnail {
            width: 120px;
            height: 68px;
            border-radius: 8px;
            object-fit: cover;
            border: 1px solid #e2e8f0;
        }
        
        .thumbnail-placeholder {
            width: 120px;
            height: 68px;
            border-radius: 8px;
            background: #f7fafc;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #a0aec0;
            font-size: 12px;
            border: 1px solid #e2e8f0;
        }
        
        .video-status {
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .status-pending {
            background: #fed7d7;
            color: #c53030;
        }
        
        .status-success {
            background: #c6f6d5;
            color: #2f855a;
        }
        
        .status-error {
            background: #fed7d7;
            color: #c53030;
        }
        
        .output-section {
            background: #1a202c;
            border-radius: 15px;
            padding: 25px;
        }
        
        .output-section h3 {
            color: #e2e8f0;
            margin-bottom: 15px;
        }
        
        .log-output {
            background: #2d3748;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 10px;
            height: 300px;
            overflow-y: auto;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 13px;
            line-height: 1.4;
        }
        
        .log-entry {
            margin-bottom: 5px;
            word-wrap: break-word;
        }
        
        .log-info {
            color: #90cdf4;
        }
        
        .log-warning {
            color: #f6e05e;
        }
        
        .log-error {
            color: #fc8181;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
            margin: 15px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #48bb78, #38a169);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-left: 10px;
        }
        
        .status-idle {
            background: #cbd5e0;
        }
        
        .status-running {
            background: #48bb78;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .summary-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 20px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid #e2e8f0;
        }
        
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-success { color: #48bb78; }
        .stat-error { color: #f56565; }
        .stat-total { color: #667eea; }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #a0aec0;
        }
        
        .empty-state svg {
            width: 64px;
            height: 64px;
            margin-bottom: 15px;
            opacity: 0.5;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>YouTube to MeTube</h1>
            <p>Automate YouTube video downloads through MeTube</p>
            <span id="status-indicator" class="status-indicator status-idle"></span>
        </div>
        
        <div class="content">
            <!-- Configuration Section -->
            <div class="form-section">
                <h3>Configuration</h3>
                <div class="form-group">
                    <label for="metube-url">MeTube URL</label>
                    <input type="url" id="metube-url" value="http://192.168.1.76:8081" placeholder="http://your-metube-server:8081">
                </div>
            </div>
            
            <!-- Channel Processing Section -->
            <div class="form-section">
                <h3>Channel Processing</h3>
                <div class="form-group">
                    <label for="channel-url">YouTube Channel URL</label>
                    <input type="url" id="channel-url" placeholder="https://www.youtube.com/@channelname">
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="count">Video Count</label>
                        <input type="number" id="count" value="5" min="1" max="50">
                    </div>
                    <div class="form-group">
                        <label for="quality">Quality</label>
                        <select id="quality">
                            <option value="best">Best</option>
                            <option value="2160p">2160p (4K)</option>
                            <option value="1440p">1440p (2K)</option>
                            <option value="1080p">1080p (HD)</option>
                            <option value="720p">720p</option>
                            <option value="480p">480p</option>
                            <option value="worst">Worst</option>
                            <option value="audio">Audio Only</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="format">Format</label>
                        <select id="format">
                            <option value="any">Any</option>
                            <option value="mp4">MP4</option>
                            <option value="m4a">M4A</option>
                            <option value="mp3">MP3</option>
                            <option value="opus">Opus</option>
                            <option value="wav">WAV</option>
                            <option value="flac">FLAC</option>
                        </select>
                    </div>
                </div>
                
                <div class="checkbox-group">
                    <input type="checkbox" id="filter-content" checked>
                    <label for="filter-content">Filter out member-only videos, Shorts, and livestreams</label>
                </div>
                
                <div style="margin-top: 20px;">
                    <button class="btn" id="fetch-btn" onclick="fetchVideos()">Fetch Videos</button>
                    <button class="btn btn-success" id="submit-btn" onclick="submitVideos()" disabled>Submit to MeTube</button>
                </div>
            </div>
            
            <!-- Single Video Test Section -->
            <div class="form-section">
                <h3>Single Video Test</h3>
                <div class="form-group">
                    <label for="test-video-url">Test Video URL</label>
                    <input type="url" id="test-video-url" placeholder="https://www.youtube.com/watch?v=VIDEO_ID">
                </div>
                <button class="btn btn-warning" id="test-btn" onclick="testSingleVideo()">Test Single Video</button>
            </div>
            
            <!-- Videos Section -->
            <div class="videos-section">
                <h3>Found Videos</h3>
                <div class="progress-bar" id="progress-bar" style="display: none;">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
                <div class="videos-list" id="videos-list">
                    <div class="empty-state">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M16,6L18.29,8.29L13.41,13.17L9.41,9.17L2,16.59L3.41,18L9.41,12L13.41,16L19.71,9.71L22,12V6H16Z"/>
                        </svg>
                        <p>No videos found yet. Enter a channel URL and click "Fetch Videos".</p>
                    </div>
                </div>
                <div class="summary-stats" id="summary-stats" style="display: none;">
                    <div class="stat-card">
                        <div class="stat-number stat-success" id="success-count">0</div>
                        <div>Successful</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number stat-error" id="error-count">0</div>
                        <div>Failed</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number stat-total" id="total-count">0</div>
                        <div>Total</div>
                    </div>
                </div>
            </div>
            
            <!-- Downloaded Videos Management Section -->
            <div class="videos-section">
                <h3>Downloaded Videos by Channel</h3>
                
                <!-- Auto-refresh Controls -->
                <div class="form-section" style="margin-bottom: 20px;">
                    <h4 style="margin-bottom: 15px;">Auto-refresh Settings</h4>
                    <div class="form-row">
                        <div class="checkbox-group">
                            <input type="checkbox" id="auto-refresh-enabled" checked onchange="toggleAutoRefresh()">
                            <label for="auto-refresh-enabled">Enable auto-refresh</label>
                        </div>
                        <div class="form-group">
                            <label for="refresh-interval">Refresh interval (seconds)</label>
                            <input type="number" id="refresh-interval" value="30" min="10" max="300" onchange="updateRefreshInterval()">
                        </div>
                        <div class="form-group">
                            <label>Next refresh: <span id="next-refresh-time">--</span></label>
                            <div style="margin-top: 5px;">
                                <span id="auto-refresh-status" class="video-status status-pending">Auto-refresh disabled</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <button class="btn btn-warning" id="fetch-downloaded-btn" onclick="fetchDownloadedVideos()">Fetch Downloaded Videos</button>
                    <button class="btn" id="expand-all-btn" onclick="expandAllChannels()" style="display: none;">Expand All</button>
                    <button class="btn" id="collapse-all-btn" onclick="collapseAllChannels()" style="display: none;">Collapse All</button>
                    <button class="btn btn-danger" id="delete-all-btn" onclick="deleteAllVideos()" style="display: none;" disabled>Delete All</button>
                    <button class="btn" id="clear-history-btn" onclick="clearMetubeHistory()">Clear History</button>
                </div>
                
                <!-- Channel Statistics Overview -->
                <div id="channels-overview" style="display: none;">
                    <div class="summary-stats">
                        <div class="stat-card">
                            <div class="stat-number stat-total" id="total-channels">0</div>
                            <div>Channels</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number stat-success" id="total-videos">0</div>
                            <div>Videos</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number stat-total" id="total-size">0</div>
                            <div>Total Size</div>
                        </div>
                    </div>
                </div>
                
                <div id="downloaded-channels-container">
                    <div class="empty-state" id="empty-channels-state">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M19,20H4C2.89,20 2,19.1 2,18V6C2,4.89 2.89,4 4,4H10L12,6H19A2,2 0 0,1 21,8H21L4,8V18L6.14,10H23.21L20.93,18.5C20.7,19.37 19.92,20 19,20Z"/>
                        </svg>
                        <p>No downloaded videos loaded. Click "Fetch Downloaded Videos" to see your MeTube downloads organized by channel.</p>
                    </div>
                </div>
            </div>
            
            <!-- Output Section -->
            <div class="output-section">
                <h3>Output Log</h3>
                <div class="log-output" id="log-output"></div>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        let currentVideos = [];
        let downloadedVideos = [];
        let isRunning = false;
        
        // Auto-refresh variables
        let autoRefreshTimer = null;
        let autoRefreshCountdown = null;
        let autoRefreshEnabled = true;
        let refreshInterval = 30; // seconds
        let lastDownloadedCount = 0;

        // Socket event handlers
        socket.on('connect', function() {
            addLogEntry('Connected to server', 'info');
        });

        socket.on('log_message', function(data) {
            addLogEntry(data.message, data.level);
        });

        socket.on('videos_found', function(data) {
            displayVideos(data.videos, data.details);
            document.getElementById('submit-btn').disabled = false;
        });

        socket.on('progress_update', function(data) {
            updateProgress(data.current, data.total);
        });

        socket.on('video_result', function(data) {
            updateVideoStatus(data.video_url, data.success);
        });

        socket.on('submission_complete', function(data) {
            showSummaryStats(data.successful, data.failed, data.total);
            hideProgress();
        });

        socket.on('operation_started', function() {
            setRunningState(true);
        });

        socket.on('operation_finished', function() {
            setRunningState(false);
        });

        socket.on('error', function(data) {
            addLogEntry(data.message, 'error');
        });

        socket.on('downloaded_videos', function(data) {
            displayDownloadedVideos(data.videos);
        });

        socket.on('video_deleted', function(data) {
            if (data.success) {
                removeDownloadedVideo(data.video_id);
                addLogEntry('Video deleted successfully', 'info');
            } else {
                addLogEntry('Failed to delete video', 'error');
            }
        });

        socket.on('history_cleared', function(data) {
            if (data.success) {
                addLogEntry('MeTube history cleared successfully', 'info');
                // Refresh the downloaded videos list
                fetchDownloadedVideos();
            } else {
                addLogEntry('Failed to clear MeTube history or feature not available', 'warning');
            }
        });

        // UI Functions
        function addLogEntry(message, level = 'info') {
            const logOutput = document.getElementById('log-output');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${level}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logOutput.appendChild(entry);
            logOutput.scrollTop = logOutput.scrollHeight;
        }

        function setRunningState(running) {
            isRunning = running;
            const statusIndicator = document.getElementById('status-indicator');
            const buttons = ['fetch-btn', 'submit-btn', 'test-btn', 'fetch-downloaded-btn'];
            
            if (running) {
                statusIndicator.className = 'status-indicator status-running';
                buttons.forEach(id => document.getElementById(id).disabled = true);
                // Temporarily pause auto-refresh during operations
                if (autoRefreshEnabled) {
                    updateAutoRefreshStatus('Auto-refresh paused (operation running)', 'status-pending');
                }
            } else {
                statusIndicator.className = 'status-indicator status-idle';
                buttons.forEach(id => document.getElementById(id).disabled = false);
                if (currentVideos.length === 0) {
                    document.getElementById('submit-btn').disabled = true;
                }
                // Resume auto-refresh status display
                if (autoRefreshEnabled) {
                    updateAutoRefreshStatus('Auto-refresh enabled', 'status-success');
                }
            }
        }

        function displayVideos(videos, details = {}) {
            currentVideos = videos;
            const videosList = document.getElementById('videos-list');
            videosList.innerHTML = '';
            
            videos.forEach((video, index) => {
                const detail = details[video] || {};
                const title = detail.title || 'Loading...';
                const duration = detail.duration || 'Unknown';
                const suggestedQuality = detail.suggested_quality || 'best';
                const videoId = detail.video_id || '';
                const thumbnailUrls = detail.thumbnail_urls || [];
                
                const videoItem = document.createElement('div');
                videoItem.className = 'video-item';
                
                // Create thumbnail element
                let thumbnailHtml = '';
                if (videoId && thumbnailUrls.length > 0) {
                    thumbnailHtml = `<img class="video-thumbnail" src="${thumbnailUrls[0]}" 
                                    onerror="this.onerror=null; this.src='${thumbnailUrls[1] || thumbnailUrls[0]}'" 
                                    alt="Video thumbnail">`;
                } else {
                    thumbnailHtml = '<div class="thumbnail-placeholder">No thumbnail</div>';
                }
                
                videoItem.innerHTML = `
                    <input type="checkbox" id="video-${index}" checked>
                    ${thumbnailHtml}
                    <div class="video-info">
                        <div class="video-title">${title}</div>
                        <a href="${video}" target="_blank" class="video-url">${video}</a>
                    </div>
                    <div class="video-duration">${duration}</div>
                    <select class="quality-select" id="quality-${index}">
                        <option value="best" ${suggestedQuality === 'best' ? 'selected' : ''}>Best</option>
                        <option value="2160p" ${suggestedQuality === '2160p' ? 'selected' : ''}>2160p</option>
                        <option value="1440p" ${suggestedQuality === '1440p' ? 'selected' : ''}>1440p</option>
                        <option value="1080p" ${suggestedQuality === '1080p' ? 'selected' : ''}>1080p</option>
                        <option value="720p" ${suggestedQuality === '720p' ? 'selected' : ''}>720p</option>
                        <option value="480p" ${suggestedQuality === '480p' ? 'selected' : ''}>480p</option>
                        <option value="worst" ${suggestedQuality === 'worst' ? 'selected' : ''}>Worst</option>
                        <option value="audio" ${suggestedQuality === 'audio' ? 'selected' : ''}>Audio</option>
                    </select>
                    <span class="video-status status-pending" id="status-${index}">Pending</span>
                `;
                videosList.appendChild(videoItem);
            });
        }

        function updateVideoStatus(videoUrl, success) {
            const videoIndex = currentVideos.indexOf(videoUrl);
            if (videoIndex !== -1) {
                const statusElement = document.getElementById(`status-${videoIndex}`);
                if (success) {
                    statusElement.textContent = 'Success';
                    statusElement.className = 'video-status status-success';
                } else {
                    statusElement.textContent = 'Failed';
                    statusElement.className = 'video-status status-error';
                }
            }
        }

        function updateProgress(current, total) {
            const progressBar = document.getElementById('progress-bar');
            const progressFill = document.getElementById('progress-fill');
            
            progressBar.style.display = 'block';
            const percentage = (current / total) * 100;
            progressFill.style.width = `${percentage}%`;
        }

        function hideProgress() {
            document.getElementById('progress-bar').style.display = 'none';
        }

        function showSummaryStats(successful, failed, total) {
            document.getElementById('success-count').textContent = successful;
            document.getElementById('error-count').textContent = failed;
            document.getElementById('total-count').textContent = total;
            document.getElementById('summary-stats').style.display = 'grid';
        }

        // Action Functions
        function fetchVideos() {
            const channelUrl = document.getElementById('channel-url').value.trim();
            if (!channelUrl) {
                alert('Please enter a channel URL');
                return;
            }

            const count = document.getElementById('count').value;
            const filterContent = document.getElementById('filter-content').checked;

            // Clear previous results
            document.getElementById('videos-list').innerHTML = '';
            document.getElementById('summary-stats').style.display = 'none';
            document.getElementById('submit-btn').disabled = true;
            
            socket.emit('fetch_videos', {
                channel_url: channelUrl,
                count: count,
                filter_content: filterContent
            });
        }

        function submitVideos() {
            const metubeUrl = document.getElementById('metube-url').value.trim();
            if (!metubeUrl) {
                alert('Please enter a MeTube URL');
                return;
            }

            if (currentVideos.length === 0) {
                alert('No videos to submit. Fetch videos first.');
                return;
            }

            // Get selected videos with their individual quality settings
            const selectedVideos = [];
            currentVideos.forEach((video, index) => {
                if (document.getElementById(`video-${index}`).checked) {
                    const individualQuality = document.getElementById(`quality-${index}`).value;
                    selectedVideos.push({
                        index: index,
                        url: video,
                        quality: individualQuality
                    });
                }
            });

            if (selectedVideos.length === 0) {
                alert('Please select at least one video to submit');
                return;
            }

            const formatType = document.getElementById('format').value;

            socket.emit('submit_videos', {
                metube_url: metubeUrl,
                format_type: formatType,
                selected_videos: selectedVideos
            });
        }

        function testSingleVideo() {
            const videoUrl = document.getElementById('test-video-url').value.trim();
            const metubeUrl = document.getElementById('metube-url').value.trim();
            
            if (!videoUrl) {
                alert('Please enter a test video URL');
                return;
            }
            
            if (!metubeUrl) {
                alert('Please enter a MeTube URL');
                return;
            }

            const quality = document.getElementById('quality').value;
            const formatType = document.getElementById('format').value;

            socket.emit('test_video', {
                video_url: videoUrl,
                metube_url: metubeUrl,
                quality: quality,
                format_type: formatType
            });
        }

        function selectAllVideos() {
            currentVideos.forEach((video, index) => {
                document.getElementById(`video-${index}`).checked = true;
            });
        }

        function selectNoneVideos() {
            currentVideos.forEach((video, index) => {
                document.getElementById(`video-${index}`).checked = false;
            });
        }

        // Downloaded videos management functions
        function fetchDownloadedVideos(isAutoRefresh = false) {
            const metubeUrl = document.getElementById('metube-url').value.trim();
            if (!metubeUrl) {
                if (!isAutoRefresh) {
                    alert('Please enter a MeTube URL');
                }
                return;
            }

            socket.emit('fetch_downloaded', {
                metube_url: metubeUrl
            });
        }

        function extractVideoId(url) {
            if (!url) return '';
            const match = url.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([a-zA-Z0-9_-]{11})/);
            return match ? match[1] : '';
        }

        function displayDownloadedVideos(videos) {
            // Check if this is a change from auto-refresh
            const isNewContent = videos.length !== lastDownloadedCount;
            if (isNewContent && lastDownloadedCount > 0) {
                if (videos.length > lastDownloadedCount) {
                    addLogEntry(`Auto-refresh found ${videos.length - lastDownloadedCount} new downloaded video(s)`, 'info');
                } else if (videos.length < lastDownloadedCount) {
                    addLogEntry(`Auto-refresh detected ${lastDownloadedCount - videos.length} video(s) removed`, 'info');
                }
            }
            lastDownloadedCount = videos.length;
            
            downloadedVideos = videos;
            const container = document.getElementById('downloaded-channels-container');
            const emptyState = document.getElementById('empty-channels-state');
            const overview = document.getElementById('channels-overview');
            
            if (videos.length === 0) {
                container.innerHTML = '';
                container.appendChild(emptyState);
                overview.style.display = 'none';
                hideChannelControls();
                return;
            }

            // Group videos by channel
            const channelGroups = groupVideosByChannel(videos);
            
            // Show overview and controls
            updateChannelOverview(channelGroups, videos);
            showChannelControls();
            
            // Clear container and hide empty state
            emptyState.remove();
            container.innerHTML = '';
            
            // Create channel sections
            Object.keys(channelGroups).forEach(channelName => {
                const channelVideos = channelGroups[channelName];
                const channelSection = createChannelSection(channelName, channelVideos);
                container.appendChild(channelSection);
            });
        }

        function groupVideosByChannel(videos) {
            const groups = {};
            
            videos.forEach(video => {
                // Extract channel name from filepath or use "Unknown Channel"
                let channelName = 'Unknown Channel';
                const filepath = video.filepath || video.filename;
                
                // If filepath contains a folder structure, extract channel name
                if (filepath && filepath.includes('/')) {
                    channelName = filepath.split('/')[0];
                } else if (video.folder) {
                    channelName = video.folder;
                }
                
                if (!groups[channelName]) {
                    groups[channelName] = [];
                }
                groups[channelName].push(video);
            });
            
            return groups;
        }

        function createChannelSection(channelName, videos) {
            const section = document.createElement('div');
            section.className = 'channel-section';
            section.id = `channel-${channelName.replace(/[^a-zA-Z0-9]/g, '-')}`;
            
            const totalSize = videos.reduce((sum, v) => {
                const filesize = v.filesize;
                if (filesize === 'unknown' || filesize === null || filesize === undefined) {
                    return sum;
                }
                const size = typeof filesize === 'string' ? parseFloat(filesize) : filesize;
                return sum + (isNaN(size) ? 0 : size);
            }, 0);
            const channelInitials = getChannelInitials(channelName);
            const avatarColor = getChannelColor(channelName);
            
            section.innerHTML = `
                <div class="channel-header" onclick="toggleChannel('${section.id}')">
                    <div class="channel-info">
                        <div class="channel-avatar" style="background: ${avatarColor}">
                            ${channelInitials}
                        </div>
                        <div class="channel-details">
                            <h3>${channelName}</h3>
                            <div class="channel-stats">
                                ${videos.length} video${videos.length !== 1 ? 's' : ''} • ${totalSize > 0 ? formatFileSize(totalSize) : 'Size Unknown'}
                            </div>
                        </div>
                    </div>
                    <div class="channel-controls">
                        <button class="btn-channel btn-channel-danger" onclick="deleteChannelVideos(event, '${channelName}')" title="Delete all videos from this channel">
                            Delete All
                        </button>
                        <button class="channel-toggle" id="toggle-${section.id}">
                            ▼
                        </button>
                    </div>
                </div>
                <div class="channel-videos" id="videos-${section.id}">
                    ${videos.map(video => createVideoItem(video)).join('')}
                </div>
                <div class="channel-summary">
                    <div class="summary-item">
                        <div class="summary-number">${videos.length}</div>
                        <div class="summary-label">Videos</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-number">${totalSize > 0 ? formatFileSize(totalSize) : 'Size Unknown'}</div>
                        <div class="summary-label">Total Size</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-number">${getLatestDate(videos)}</div>
                        <div class="summary-label">Latest</div>
                    </div>
                </div>
            `;
            
            return section;
        }

        function createVideoItem(video) {
            const filesize = formatFileSize(video.filesize);
            const timestamp = formatTimestamp(video.timestamp);
            const filepath = video.filepath || video.filename;
            const videoId = extractVideoId(video.url);
            
            let thumbnailHtml = '';
            if (videoId) {
                const thumbnailUrls = [
                    `https://img.youtube.com/vi/${videoId}/maxresdefault.jpg`,
                    `https://img.youtube.com/vi/${videoId}/hqdefault.jpg`,
                    `https://img.youtube.com/vi/${videoId}/mqdefault.jpg`
                ];
                thumbnailHtml = `<img class="video-thumbnail" src="${thumbnailUrls[0]}" 
                                onerror="this.onerror=null; this.src='${thumbnailUrls[1]}'" 
                                alt="Video thumbnail">`;
            } else {
                thumbnailHtml = '<div class="thumbnail-placeholder">No thumbnail</div>';
            }
            
            return `
                <div class="channel-video-item" id="downloaded-${video.id}">
                    ${thumbnailHtml}
                    <div class="video-info">
                        <div class="video-title">${video.title}</div>
                        <a href="${video.url}" target="_blank" class="video-url">${video.url}</a>
                        <div style="font-size: 12px; color: #718096; margin-top: 4px;">
                            Downloaded: ${timestamp}
                        </div>
                    </div>
                    <div class="video-filesize">${filesize}</div>
                    <div class="channel-actions">
                        <button class="btn btn-danger btn-small" onclick="deleteVideo('${video.id}', '${video.filename}', '${filepath}')">
                            Delete
                        </button>
                    </div>
                    <span class="video-status status-pending" id="delete-status-${video.id}"></span>
                </div>
            `;
        }

        function deleteVideo(videoId, filename, filepath) {
            const displayName = filepath && filepath !== filename ? filepath : filename;
            if (!confirm(`Are you sure you want to delete "${displayName}"?`)) {
                return;
            }

            const metubeUrl = document.getElementById('metube-url').value.trim();
            if (!metubeUrl) {
                alert('Please enter a MeTube URL');
                return;
            }

            socket.emit('delete_video', {
                metube_url: metubeUrl,
                video_id: videoId,
                filename: filename,
                filepath: filepath || filename
            });
        }

        function removeDownloadedVideo(videoId) {
            const videoElement = document.getElementById(`downloaded-${videoId}`);
            if (videoElement) {
                videoElement.remove();
            }
            
            // Update downloaded videos array
            downloadedVideos = downloadedVideos.filter(video => video.id !== videoId);
            
            // Hide delete all button if no videos left
            if (downloadedVideos.length === 0) {
                const deleteAllBtn = document.getElementById('delete-all-btn');
                deleteAllBtn.style.display = 'none';
                
                // Show empty state
                const downloadedList = document.getElementById('downloaded-videos-list');
                downloadedList.innerHTML = `
                    <div class="empty-state">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M19,20H4C2.89,20 2,19.1 2,18V6C2,4.89 2.89,4 4,4H10L12,6H19A2,2 0 0,1 21,8H21L4,8V18L6.14,10H23.21L20.93,18.5C20.7,19.37 19.92,20 19,20Z"/>
                        </svg>
                        <p>All videos have been deleted.</p>
                    </div>
                `;
            }
        }

        function deleteAllVideos() {
            if (!confirm(`Are you sure you want to delete ALL ${downloadedVideos.length} downloaded videos? This cannot be undone!`)) {
                return;
            }

            downloadedVideos.forEach(video => {
                deleteVideo(video.id, video.filename, video.filepath || video.filename);
            });
        }

        function formatFileSize(bytes) {
            if (!bytes || bytes === 0 || bytes === null || bytes === undefined || bytes === 'unknown') {
                return 'Size Unknown';
            }
            
            if (typeof bytes === 'string') {
                if (bytes === 'unknown') return 'Size Unknown';
                bytes = parseFloat(bytes);
                if (isNaN(bytes)) return 'Size Unknown';
            }
            
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(1024));
            return Math.round(bytes / Math.pow(1024, i) * 100) / 100 + ' ' + sizes[i];
        }

        function formatTimestamp(timestamp) {
            if (!timestamp || timestamp === 'Unknown' || timestamp === null || timestamp === undefined) {
                return 'Unknown';
            }
            
            // Handle different timestamp formats
            let date;
            if (typeof timestamp === 'string') {
                // Try parsing ISO string first
                date = new Date(timestamp);
                if (isNaN(date.getTime())) {
                    // Try parsing as number if string parsing fails
                    const numTimestamp = parseFloat(timestamp);
                    if (!isNaN(numTimestamp)) {
                        date = convertTimestampToDate(numTimestamp);
                    }
                }
            } else if (typeof timestamp === 'number') {
                date = convertTimestampToDate(timestamp);
            } else {
                return 'Unknown';
            }
            
            if (isNaN(date.getTime())) {
                console.warn('Could not parse timestamp:', timestamp);
                return 'Unknown';
            }
            
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
        }

        function convertTimestampToDate(timestamp) {
            // Handle different timestamp precisions
            if (timestamp > 1000000000000000000) {
                // Nanoseconds (like 1754959554781207300)
                // Convert nanoseconds to milliseconds by dividing by 1,000,000
                return new Date(timestamp / 1000000);
            } else if (timestamp > 1000000000000) {
                // Milliseconds  
                return new Date(timestamp);
            } else {
                // Seconds
                return new Date(timestamp * 1000);
            }
        }

        function clearMetubeHistory() {
            const metubeUrl = document.getElementById('metube-url').value.trim();
            if (!metubeUrl) {
                alert('Please enter a MeTube URL');
                return;
            }

            if (!confirm('Are you sure you want to clear the entire MeTube download history? This cannot be undone!')) {
                return;
            }

            socket.emit('clear_history', {
                metube_url: metubeUrl
            });
        }

        // Channel management helper functions
        function getChannelInitials(channelName) {
            return channelName
                .split(' ')
                .map(word => word.charAt(0).toUpperCase())
                .join('')
                .substring(0, 2);
        }

        function getChannelColor(channelName) {
            const colors = [
                '#667eea', '#764ba2', '#f093fb', '#f5576c', '#4facfe',
                '#43e97b', '#fa709a', '#fee140', '#a8edea', '#d299c2'
            ];
            let hash = 0;
            for (let i = 0; i < channelName.length; i++) {
                hash = channelName.charCodeAt(i) + ((hash << 5) - hash);
            }
            return colors[Math.abs(hash) % colors.length];
        }

        function getLatestDate(videos) {
            if (videos.length === 0) return 'N/A';
            
            // Filter out invalid timestamps and convert to numbers
            const validTimestamps = videos
                .map(v => {
                    let timestamp = v.timestamp;
                    if (!timestamp) return 0;
                    
                    if (typeof timestamp === 'string') {
                        const parsed = parseFloat(timestamp);
                        return isNaN(parsed) ? 0 : parsed;
                    }
                    return typeof timestamp === 'number' ? timestamp : 0;
                })
                .filter(t => t > 0);
            
            if (validTimestamps.length === 0) return 'N/A';
            
            const latestTimestamp = Math.max(...validTimestamps);
            
            // Use the same timestamp conversion logic
            const date = convertTimestampToDate(latestTimestamp);
            
            if (isNaN(date.getTime())) return 'N/A';
            
            return date.toLocaleDateString();
        }

        function updateChannelOverview(channelGroups, allVideos) {
            const totalChannels = Object.keys(channelGroups).length;
            const totalVideos = allVideos.length;
            
            // Calculate total size, handling unknown filesizes
            let totalSize = 0;
            let hasUnknownSizes = false;
            
            allVideos.forEach(v => {
                if (v.filesize === 'unknown' || v.filesize === null || v.filesize === undefined) {
                    hasUnknownSizes = true;
                } else {
                    const filesize = typeof v.filesize === 'string' ? parseFloat(v.filesize) : (v.filesize || 0);
                    if (!isNaN(filesize)) {
                        totalSize += filesize;
                    } else {
                        hasUnknownSizes = true;
                    }
                }
            });


            document.getElementById('total-channels').textContent = totalChannels;
            document.getElementById('total-videos').textContent = totalVideos;
            
            // Show size with indication if some are unknown
            if (hasUnknownSizes && totalSize === 0) {
                document.getElementById('total-size').textContent = 'Sizes Unknown';
            } else if (hasUnknownSizes) {
                document.getElementById('total-size').textContent = formatFileSize(totalSize) + '+';
            } else {
                document.getElementById('total-size').textContent = formatFileSize(totalSize);
            }
            
            document.getElementById('channels-overview').style.display = 'block';
        }

        function showChannelControls() {
            document.getElementById('expand-all-btn').style.display = 'inline-block';
            document.getElementById('collapse-all-btn').style.display = 'inline-block';
            document.getElementById('delete-all-btn').style.display = 'inline-block';
            document.getElementById('delete-all-btn').disabled = false;
        }

        function hideChannelControls() {
            document.getElementById('expand-all-btn').style.display = 'none';
            document.getElementById('collapse-all-btn').style.display = 'none';
            document.getElementById('delete-all-btn').style.display = 'none';
        }

        function toggleChannel(sectionId) {
            const videosContainer = document.getElementById(`videos-${sectionId}`);
            const toggleButton = document.getElementById(`toggle-${sectionId}`);
            const header = document.querySelector(`#${sectionId} .channel-header`);
            
            if (videosContainer.classList.contains('collapsed')) {
                videosContainer.classList.remove('collapsed');
                toggleButton.textContent = '▼';
                header.classList.remove('collapsed');
            } else {
                videosContainer.classList.add('collapsed');
                toggleButton.textContent = '▶';
                header.classList.add('collapsed');
            }
        }

        function expandAllChannels() {
            document.querySelectorAll('.channel-videos').forEach(container => {
                container.classList.remove('collapsed');
            });
            document.querySelectorAll('.channel-toggle').forEach(btn => {
                btn.textContent = '▼';
            });
            document.querySelectorAll('.channel-header').forEach(header => {
                header.classList.remove('collapsed');
            });
        }

        function collapseAllChannels() {
            document.querySelectorAll('.channel-videos').forEach(container => {
                container.classList.add('collapsed');
            });
            document.querySelectorAll('.channel-toggle').forEach(btn => {
                btn.textContent = '▶';
            });
            document.querySelectorAll('.channel-header').forEach(header => {
                header.classList.add('collapsed');
            });
        }

        function deleteChannelVideos(event, channelName) {
            event.stopPropagation(); // Prevent toggle
            
            const channelVideos = downloadedVideos.filter(video => {
                const filepath = video.filepath || video.filename;
                const videoChannelName = filepath.includes('/') ? filepath.split('/')[0] : (video.folder || 'Unknown Channel');
                return videoChannelName === channelName;
            });

            if (!confirm(`Are you sure you want to delete ALL ${channelVideos.length} videos from "${channelName}"? This cannot be undone!`)) {
                return;
            }

            channelVideos.forEach(video => {
                deleteVideo(video.id, video.filename, video.filepath || video.filename);
            });
        }

        // Auto-refresh functionality
        function toggleAutoRefresh() {
            autoRefreshEnabled = document.getElementById('auto-refresh-enabled').checked;
            
            if (autoRefreshEnabled) {
                startAutoRefresh();
                updateAutoRefreshStatus('Auto-refresh enabled', 'status-success');
                addLogEntry('Auto-refresh enabled', 'info');
            } else {
                stopAutoRefresh();
                updateAutoRefreshStatus('Auto-refresh disabled', 'status-pending');
                addLogEntry('Auto-refresh disabled', 'info');
            }
        }
        
        function updateRefreshInterval() {
            const newInterval = parseInt(document.getElementById('refresh-interval').value);
            if (newInterval >= 10 && newInterval <= 300) {
                refreshInterval = newInterval;
                if (autoRefreshEnabled) {
                    // Restart with new interval
                    stopAutoRefresh();
                    startAutoRefresh();
                }
                addLogEntry(`Auto-refresh interval updated to ${refreshInterval} seconds`, 'info');
            }
        }
        
        function startAutoRefresh() {
            if (!autoRefreshEnabled) return;
            
            stopAutoRefresh(); // Clear any existing timers
            
            // Start the auto-refresh timer
            autoRefreshTimer = setTimeout(() => {
                if (autoRefreshEnabled && !isRunning) {
                    addLogEntry('Auto-refreshing downloaded videos...', 'info');
                    fetchDownloadedVideos(true); // Pass true to indicate auto-refresh
                }
                startAutoRefresh(); // Schedule next refresh
            }, refreshInterval * 1000);
            
            // Start countdown display
            startCountdown();
        }
        
        function stopAutoRefresh() {
            if (autoRefreshTimer) {
                clearTimeout(autoRefreshTimer);
                autoRefreshTimer = null;
            }
            if (autoRefreshCountdown) {
                clearInterval(autoRefreshCountdown);
                autoRefreshCountdown = null;
            }
            document.getElementById('next-refresh-time').textContent = '--';
        }
        
        function startCountdown() {
            let secondsLeft = refreshInterval;
            
            const updateCountdown = () => {
                if (!autoRefreshEnabled) {
                    document.getElementById('next-refresh-time').textContent = '--';
                    return;
                }
                
                const minutes = Math.floor(secondsLeft / 60);
                const seconds = secondsLeft % 60;
                const timeString = minutes > 0 ? `${minutes}m ${seconds}s` : `${seconds}s`;
                document.getElementById('next-refresh-time').textContent = timeString;
                
                secondsLeft--;
                
                if (secondsLeft < 0) {
                    clearInterval(autoRefreshCountdown);
                    return;
                }
            };
            
            updateCountdown(); // Initial call
            autoRefreshCountdown = setInterval(updateCountdown, 1000);
        }
        
        function updateAutoRefreshStatus(text, statusClass) {
            const statusElement = document.getElementById('auto-refresh-status');
            statusElement.textContent = text;
            statusElement.className = `video-status ${statusClass}`;
        }
        
        // Initialize auto-refresh when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Start auto-refresh if enabled
            if (autoRefreshEnabled) {
                setTimeout(() => {
                    startAutoRefresh();
                    updateAutoRefreshStatus('Auto-refresh enabled', 'status-success');
                }, 2000); // Wait 2 seconds after page load
            }
        });
        
        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'Enter' && !isRunning) {
                if (document.getElementById('channel-url').value.trim()) {
                    fetchVideos();
                }
            }
        });
    </script>
</body>
</html>